{% extends "bookshelf/base.html" %}

{% block title %}Book List - Library Management System{% endblock %}

{% block content %}
<h1>Book List</h1>

<!-- Security: Safe search form -->
<form method="get" action="." style="margin-bottom: 20px;">
    <input type="text" name="q" placeholder="Search books by title or author..." 
           value="{{ request.GET.q|default:'' }}" style="padding: 8px; width: 300px;">
    <button type="submit" class="btn btn-primary">Search</button>
    
    {% if request.GET.q %}
    <a href="{% url 'bookshelf:book_list' %}" class="btn btn-secondary">Clear</a>
    {% endif %}
</form>

<!-- Security: Display search query safely -->
{% if request.GET.q %}
<p>Search results for: <strong>{{ request.GET.q }}</strong></p>
{% endif %}

{% if books %}
<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f8f9fa;">
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Title</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Author</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for book in books %}
        <tr>
            <!-- Security: Always escape user-generated content -->
            <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                <strong>{{ book.title|escape }}</strong>
            </td>
            <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                {{ book.author.name|escape }}
            </td>
            <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                <!-- Security: Safe URL construction -->
                <a href="{% url 'bookshelf:book_detail' book.id %}" class="btn btn-primary">View</a>
                
                {% if perms.bookshelf.can_edit %}
                <a href="{% url 'bookshelf:book_edit' book.id %}" class="btn btn-secondary">Edit</a>
                {% endif %}
                
                {% if perms.bookshelf.can_delete %}
                <a href="{% url 'bookshelf:book_delete' book.id %}" class="btn btn-danger">Delete</a>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No books found.</p>
{% endif %}

<!-- Security: Add book link with permission check -->
{% if perms.bookshelf.can_create %}
<div style="margin-top: 20px;">
    <a href="{% url 'bookshelf:book_add' %}" class="btn btn-primary">Add New Book</a>
</div>
{% endif %}

<!-- Security: Navigation back to main app -->
<div style="margin-top: 20px;">
    <a href="{% url 'relationship_app:list_books' %}">‚Üê Back to Main Library</a>
</div>
{% endblock %}